# complete-app-ingress.yaml
# Example: Real-world multi-service application
# Frontend at /
# API at /api/*
# Admin at /admin/*

---
# Frontend (Static website)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  labels:
    app: frontend
spec:
  replicas: 2
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
      - name: nginx
        image: nginx:1.25
        ports:
        - containerPort: 80

---
apiVersion: v1
kind: Service
metadata:
  name: frontend-service
spec:
  selector:
    app: frontend
  ports:
  - port: 80

---
# Backend API
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api
  labels:
    app: api
spec:
  replicas: 3
  selector:
    matchLabels:
      app: api
  template:
    metadata:
      labels:
        app: api
    spec:
      containers:
      - name: api
        image: hashicorp/http-echo:1.0
        args:
        - "-text=API Response: {status: ok, version: 1.0}"
        - "-listen=:8080"
        ports:
        - containerPort: 8080

---
apiVersion: v1
kind: Service
metadata:
  name: api-service
spec:
  selector:
    app: api
  ports:
  - port: 8080

---
# Admin Panel
apiVersion: apps/v1
kind: Deployment
metadata:
  name: admin
  labels:
    app: admin
spec:
  replicas: 1
  selector:
    matchLabels:
      app: admin
  template:
    metadata:
      labels:
        app: admin
    spec:
      containers:
      - name: admin
        image: hashicorp/http-echo:1.0
        args:
        - "-text=Admin Panel - Dashboard"
        - "-listen=:3000"
        ports:
        - containerPort: 3000

---
apiVersion: v1
kind: Service
metadata:
  name: admin-service
spec:
  selector:
    app: admin
  ports:
  - port: 3000

---
# Ingress for all services
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: complete-app-ingress
  annotations:
    # Strip path prefix before forwarding
    nginx.ingress.kubernetes.io/rewrite-target: /$2
spec:
  ingressClassName: nginx
  rules:
  - host: myapp.local
    http:
      paths:
      # API endpoints - must come first (more specific)
      - path: /api(/|$)(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: api-service
            port:
              number: 8080
      
      # Admin panel
      - path: /admin(/|$)(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: admin-service
            port:
              number: 3000
      
      # Frontend - catch all remaining paths (must be last)
      - path: /()(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: frontend-service
            port:
              number: 80

# Prerequisites:
# 1. NGINX Ingress Controller: minikube addons enable ingress
#
# Usage:
# kubectl apply -f complete-app-ingress.yaml
#
# Add to /etc/hosts:
# 192.168.49.2  myapp.local
#
# Test all endpoints:
# curl http://myapp.local/
# curl http://myapp.local/api/users
# curl http://myapp.local/admin
#
# Or visit in browser:
# http://myapp.local/
# http://myapp.local/api/users
# http://myapp.local/admin
#
# Note: Order matters!
# - More specific paths (/api, /admin) must come before generic paths (/)
# - Otherwise generic path will match everything
